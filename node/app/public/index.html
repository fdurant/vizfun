<html ng-app="musicVizFunApp">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Music visualization</title>
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../bower_components/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="../bower_components/bootstrap-social/bootstrap-social.css" rel="stylesheet">
    <link href="mystyles.css" rel="stylesheet">
    <script src="../bower_components/angular/angular.min.js"></script>
    <script src="app.js"></script>

    <!-- Copied from https://github.com/spotify/web-api-auth-examples/blob/master/authorization_code/public/index.html -->
    <style type="text/css">
      #login {
        padding-top: 50px;
        padding-bottom: 50px;
      }
      #loggedin {
        display: none;
      }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
    </style>

  </head>

  <body ng-controller="MusicVizFunController">

    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">

      <div class="container">

	<div class="navbar-header">
	  <button type="button"
		  class="navbar-toggle collapsed"
		  data-toggle="collapse"
		  data-target="#navbar"
		  aria-expanded="false"
		  aria-controls="navbar">
	    <span class="sr-only">Toggle navigation</span>
	    <span class="icon-bar"></span>
	    <span class="icon-bar"></span>
	    <span class="icon-bar"></span>
	  </button>
	  <a class="navbar-brand" href="#">Music.viz.fun</a>
	</div>

	<div id="navbar" class="navbar-collapse collapse">
	
	  <ul class="nav navbar-nav">
	    <li class="active"><a href="#">
		<span class="glyphicon glyphicon-home" aria-hidden="true"></span>
		Home</a></li>
	    <li><a href="#">Start here</a></li>
	    <li class="dropdown">
	      <a href="#"
		 class="dropdown-toggle"
		 data-toggle="dropdown"
		 role="button"
		 aria-haspopup="true"
		 aria-expanded="false">
		<span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
		About
		<span class="caret"></span>
	      </a>
	      <ul class="dropdown-menu">
		<li class="dropdown-header">Singular</li>
		<li><a href="#">Me</a></li>
		<li><a href="#">You</a></li>
		<li role="separator" class="divider"></li>
		<li class="dropdown-header">Plural</li>
		<li><a href="#">Us</a></li>
		<li><a href="#">Them</a></li>
	      </ul>
	    </li>
	  </ul>
	  
	  <ul class="nav navbar-nav navbar-right">
	    <div ng-show="userIsLoggedIn" class="loggedin-user">
	      <img ng-src="{{urlOfLoggedInUserImage}}" width="30" height="30" class="img-circle" alt="photo of {{loggedInUserName}}"></img>
	      <span class="loggedin-username">{{loggedInUserName}}</span>
	    </div>
	    <!--li><a href="/login" class="btn btn-primary">Log in with Spotify</a></li>
	    <li><a href="#">Contact</a></li-->
	  </ul>
	  
	</div><!-- id="navbar "-->
	  
      </div><!-- class="container" -->
	
    </nav>

    <!--header class="jumbotron">

      <div class="container">

	<div class="row row-header">

	  <div class="col-xs-12 col-sm-8" style="border-width:1px; border-color:green; border-style:solid">Two thirds

	  </div>
	  <div class="col-xs-12 col-sm-4"  style="border-width:1px; border-color:red; border-style:solid">One third
	  </div>
	  
	</div>
      
      </div>

    </header-->

    <!--div class="container">

      <div class="row row-content">

          <div class="someClass" ng-init="whatever={comment:''}"></div>
	  <p>Hello {{whatever.comment}}</p>
	  <input type="text" ng-model="whatever.comment"/>

      </div>
      
    </div-->
      
    <!-- Next elements all copied from https://github.com/spotify/web-api-auth-examples/blob/master/authorization_code/public/index.html -->
    <div class="container">
      <div id="login" class="text-center" ng-hide="userIsLoggedIn">
	<!--h1>This is an example of the Authorization Code flow</h1-->
	<a href="/login" class="btn btn-primary btn-lg">Log in with Spotify</a>
      </div>
      <div id="loggedin">
	<div id="user-profile">
	</div>
	<div id="oauth">
	</div>
	<button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>
      </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
      <h1>Logged in as {{display_name}}</h1>
      <div class="media">
	<div class="pull-left">
	  <img class="media-object" width="150" src="{{images.0.url}}" />
	</div>
	<div class="media-body">
	  <dl class="dl-horizontal">
	    <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
	    <dt>Id</dt><dd>{{id}}</dd>
	    <dt>Email</dt><dd>{{email}}</dd>
	    <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
	    <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
	    <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
	    <dt>Country</dt><dd>{{country}}</dd>
	  </dl>
	</div>
      </div>
    </script>

    <script id="oauth-template" type="text/x-handlebars-template">
      <h2>oAuth info</h2>
      <dl class="dl-horizontal">
	<dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
	<dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}></dd>
      </dl>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>

    (function() {

    /**
     * Obtains parameters from the hash of the URL
     * @return Object
     */

    function getHashParams() {
	var hashParams = {};
	var e, r = /([^&;=]+)=?([^&;]*)/g,
	    q = window.location.hash.substring(1);
	while ( e = r.exec(q)) {
	    hashParams[e[1]] = decodeURIComponent(e[2]);
	}
	return hashParams;
    }

    var userProfileSource = document.getElementById('user-profile-template').innerHTML,
	userProfileTemplate = Handlebars.compile(userProfileSource),
	userProfilePlaceholder = document.getElementById('user-profile');

    var oauthSource = document.getElementById('oauth-template').innerHTML,
	oauthTemplate = Handlebars.compile(oauthSource),
	oauthPlaceholder = document.getElementById('oauth');

    var params = getHashParams();

    var access_token = params.access_token,
	refresh_token = params.refresh_token,
	error = params.error;

    if (error) {
	alert('There was an error during the authentication');
    }
    else {

	if (access_token) {

	    // render oauth info
	    oauthPlaceholder.innerHTML = oauthTemplate({
		access_token: access_token,
		refresh_token: refresh_token
	    });

	    $.ajax({
		url: 'https://api.spotify.com/v1/me',
		headers: {
		    'Authorization': 'Bearer ' + access_token
		},
		success: function(response) {
		    userProfilePlaceholder.innerHTML = userProfileTemplate(response);
		    $('#login').hide();
		    $('#loggedin').show();
		}
	    });
	}
	else {
	    // render initial screen
	    $('#login').show();
	    $('#loggedin').hide();
	}

	document.getElementById('obtain-new-token').addEventListener('click', function() {
	    $.ajax({
		url: '/refresh_token',
		data: {
		    'refresh_token': refresh_token
		}
	    }).done(function(data) {
		access_token = data.access_token;
		oauthPlaceholder.innerHTML = oauthTemplate({
		    access_token: access_token,
		    refresh_token: refresh_token
		});
	    });
	}, false);
    }
})();

    </script>

    <nav class="navbar navbar-fixed-bottom">

      <footer>

	<div class="container">

	  <div class="row row-footer">

	    <div class="col-xs-4" style="align:center">&copy; Frederik Durant, 2017</div>
	    <div class="col-xs-4" style="align:center"><i class="fa fa-envelope"></i>: music@viz.fun</div>
	    <div class="col-xs-4" style="align:center"><a class="btn btn-social-icon btn-linkedin" href="http://linkedin.com/in/fdurant"><i class="fa fa-linkedin"></i></a></div>

	  </div>
	  
	</div>
	
      </footer>

    </nav>
      
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>

    <!-- Include all compiled plugins (below), or inclide individual files as needed-->
    <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

</body>
  
</html>
